# shamelessly borrowed from sqlcollabortive/dbatools/.github/workflows/tests.yml
name: Run SQL Tests
on: [push]
defaults:
  run:
    shell: pwsh
jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      # GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      # Following are standard MSSQL environment variables
      # I'm not working with the SQL Agent here, so I don't need to enable it.
      # MSSQL_AGENT_ENABLED: True
      SA_PASSWORD: ${{secrets.SAPASSWORD}}
      #ACCEPT_EULA: Y
      MSSQL_PID: Developer
      TEST_SQLINSTANCE: localhost
    steps:
      - uses: actions/checkout@v2

      #########
      # I am building this command up as I figure out what is available and what I can do
      #
      # Setting 'trusted' was recommended by @potatoqualitee in a YouTube talk I watched 2021/07/30.
      # I need a command to 'run stuff on SQL', I originally choose microsoft\sqlserver\invoke-sqlcmd even though sqlcollaborative\invoke-sqlcmd2\invoke-sqlcmd2 is better.
      # Maybe sqlserver isn't available. The docs I've read indicate that it would be, but when this ran, the log said that it couldn't find Invoke-Sqlcmd.
      # I'll try installing invoke-sqlcmd2 and using that, instead.
      #
      # do I need to build a $Credential using sa and the password from then environment?
      - name: Install Pre-Requisites
        run: |
          Get-Module -listavailable -Name dbatools,sqlserver,pester,invoke-sqlcmd2
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module -Name dbatools -RequiredVersion '1.0.161'
          Install-Module -Name invoke-sqlcmd2 -RequiredVersion '1.6.4'

      #########
      # original uses a pair of custom-built dbatools sql images. I changed that to use the generic images from MS.
      # I also removed the additional port mappings, I believe that's just for db mirroring (which gets tested using those images)
      # and we do not need that...
      #
      # I do not need two instances running and the version of SQL Server is not important, I'll keep this here for safekeeping.
      # docker run -p 14333:1433 -e ACCEPT_EULA=Y --network localnet --hostname dockersql2019 --name dockersql2019 --mount 'source=shared,target=/shared' -d mcr.microsoft.com/mssql/server:2019-latest
      #
      # I am not sure if I need to specify -e  sa_password=<SA_PASSWORD> here or if it 'gets it' from the above env: section
      # If I have to specify this a -e just for the password, I'm not sure of the exact syntax.
      # People say that MSSQL_SA_PASSWORD and SA_PASSWORD both work
      #
      - name:  Setup docker images
        run: |
          # create a shared network
          docker network create localnet
          #
          # create a shared volume
          docker volume create shared
          # setup container and expose port
          Write-Host "INFO:Start the mssql container"
          docker run -p 1433:1433 -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=$($ENV:SA_PASSWORD)" --network localnet --hostname dockersql2017 --name dockersql2017 --mount 'source=shared,target=/shared' -d mcr.microsoft.com/mssql/server:2017-latest
          #docker run -p 1433:1433 -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=$($ENV:SA_PASSWORD)" --hostname dockersql2017 --name dockersql2017 --mount 'source=shared,target=/shared' -d mcr.microsoft.com/mssql/server:2017-latest
          #
          # I am guessing that we need this sleep here
          sleep 3
          #
          Write-Host "INFO:Configuring a credential"
          $Username = "sa"
          $Password = $env:SA_PASSWORD
          if ($Password) {Write-Host ">>>Password is set to something.<<<"}
          $SecureString = ConvertTo-SecureString -AsPlainText $Password -Force
          $cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username,$SecureString
          #
          Write-Host "INFO:Starting a query to dump out system stuff for troubleshooting"
          $Query = "select 'Try01' as EventName, GETDATE() RightNow, SUSER_SNAME() WhoamI, @@SERVERNAME as ServerName, @@VERSION as SqlServerVersion "
          Invoke-SqlCmd2 -Credential $Cred -ServerInstance $ENV:TEST_SQLINSTANCE -query $Query
          Write-Host "ending step"


      - name: Publish a DACPAC to the SQL Server
        run: |
          # The Docker mssql container from the prior step is still up, but you need to recreate the credential
          Write-Host "Configuring a credential"
          $Username = "sa"
          $Password = $env:SA_PASSWORD
          $SecureString = ConvertTo-SecureString -AsPlainText $Password -Force
          $cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username,$SecureString
          #
          Write-Host "INFO: Publish DACPAC"
          $Database = 'hwda'
          $exportFilePath = '.\Tests\Data\hwda.dacpac'
          $options = New-DbaDacOption -Type Dacpac -Action Publish
          $options.DeployOptions.DropObjectsNotInSource = $true
          Publish-DbaDacPackage -Credential $Cred -SqlInstance $ENV:TEST_SQLINSTANCE -Database $Database -DacOption $options -Path $exportFilePath -EnableException
          #
          Write-Host "INFO: Load the test data"
          $Query= "execute InitializeData.Initialize_All"
          Invoke-SqlCmd2 -Credential $Cred -ServerInstance $ENV:TEST_SQLINSTANCE -query $Query

      - name: Run a SQL Statement
        run: |
          # The Docker mssql container from the prior step is still up, but you need to recreate the credential
          Write-Host "Configuring a credential"
          $Username = "sa"
          $Password = $env:SA_PASSWORD
          $SecureString = ConvertTo-SecureString -AsPlainText $Password -Force
          $cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username,$SecureString
          #
          Write-Host "INFO: Try a query"
          $Query= "select name from sys.databases d "
          Invoke-SqlCmd2 -Credential $Cred -ServerInstance $ENV:TEST_SQLINSTANCE -query $Query

      - name: Run Pester Tests
        run: |
          # The credential is rebuilt in the *.Tests.ps1 file(s)
          Invoke-Pester .\Tests
